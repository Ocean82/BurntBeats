import { Logger } from '../utils/logger';
import axios from 'axios';
import { env } from '../config/env';

const logger = new Logger({ name: 'ExternalServiceHealthChecker' });

interface ServiceStatus {
  name: string;
  status: string;
  responseTime?: number;
  error?: string;
}

export class ExternalServiceHealthChecker {
  static async checkAll(): Promise<ServiceStatus[]> {
    const services = [
      { name: 'Stripe API', url: 'https://api.stripe.com/v1' },
      { name: 'Email Service', url: env.EMAIL_SERVICE_URL },
      { name: 'Storage Service', url: env.STORAGE_SERVICE_URL },
    ].filter(service => service.url);

    const results = await Promise.all(
      services.map(service => this.checkService(service))
    );

    return results;
  }

  private static async checkService(service: { name: string; url: string }): Promise<ServiceStatus> {
    const startTime = Date.now();
    
    try {
      const response = await axios.get(service.url, {
        timeout: 3000,
        headers: { 'User-Agent': 'HealthCheck/1.0' }
      });

      return {
        name: service.name,
        status: response.status === 200 ? 'available' : 'unavailable',
        responseTime: Date.now() - startTime,
      };
    } catch (error) {
      return {
        name: service.name,
        status: 'unavailable',
        responseTime: Date.now() - startTime,
        error: error.message,
      };
    }
  }
}
